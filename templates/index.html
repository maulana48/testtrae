<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burnout Detector AI</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .fade-in-up {
            animation: fadeInUp 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }

        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Custom range slider styling */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4F46E5;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #E5E7EB;
            border-radius: 2px;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Heatmap Grid */
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 4px;
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4 md:p-8">

    <div class="max-w-6xl w-full grid grid-cols-1 lg:grid-cols-12 gap-8">

        <!-- Header (Mobile only) -->
        <div class="lg:hidden col-span-1 text-center mb-4">
            <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Burnout<span
                    class="text-indigo-600">Detector</span></h1>
            <p class="text-sm text-gray-500">Student Wellness AI Assistant</p>
        </div>

        <!-- Left Column: Input Form (4 columns wide) -->
        <div class="col-span-1 lg:col-span-4 bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-gray-100 h-fit">
            <div class="hidden lg:block mb-8">
                <h1 class="text-2xl font-extrabold text-gray-900 tracking-tight">Burnout<span
                        class="text-indigo-600">Detector</span></h1>
                <p class="text-xs text-gray-400 font-medium uppercase tracking-wider mt-1">Student Wellness AI</p>
            </div>

            <form hx-post="/calculate" hx-target="#result" hx-swap="innerHTML" class="space-y-5" id="mainForm">

                <!-- Group 1: Time -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-xs font-bold mb-2 uppercase tracking-wide" for="sleep">
                            Sleep (Hrs)
                        </label>
                        <input
                            class="w-full bg-gray-50 text-gray-800 border border-gray-200 rounded-lg py-3 px-4 leading-tight focus:outline-none focus:bg-white focus:border-indigo-500 transition"
                            id="sleep" name="sleep" type="number" step="0.5" min="0" max="24" placeholder="e.g. 6"
                            required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-xs font-bold mb-2 uppercase tracking-wide" for="study">
                            Study (Hrs)
                        </label>
                        <input
                            class="w-full bg-gray-50 text-gray-800 border border-gray-200 rounded-lg py-3 px-4 leading-tight focus:outline-none focus:bg-white focus:border-indigo-500 transition"
                            id="study" name="study" type="number" step="0.5" min="0" max="24" placeholder="e.g. 4"
                            required>
                    </div>
                </div>

                <!-- Deadlines -->
                <div>
                    <label class="block text-gray-700 text-xs font-bold mb-2 uppercase tracking-wide" for="deadlines">
                        Deadlines (This Week)
                    </label>
                    <input
                        class="w-full bg-gray-50 text-gray-800 border border-gray-200 rounded-lg py-3 px-4 leading-tight focus:outline-none focus:bg-white focus:border-indigo-500 transition"
                        id="deadlines" name="deadlines" type="number" min="0" placeholder="Number of assignments/exams"
                        required>
                </div>

                <!-- Sliders Group -->
                <div class="space-y-6 pt-2">
                    <!-- Mood -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-gray-700 text-xs font-bold uppercase tracking-wide"
                                for="mood">Mood</label>
                            <span class="text-indigo-600 font-bold text-sm" id="mood-val">3</span>
                        </div>
                        <input class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" id="mood"
                            name="mood" type="range" min="1" max="5" value="3"
                            oninput="document.getElementById('mood-val').innerText = this.value">
                        <div class="flex justify-between text-[10px] text-gray-400 mt-1 font-medium">
                            <span>üòû Bad</span>
                            <span>üòê Okay</span>
                            <span>üòÑ Great</span>
                        </div>
                    </div>

                    <!-- Stress -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-gray-700 text-xs font-bold uppercase tracking-wide" for="stress">Stress
                                Level</label>
                            <span class="text-indigo-600 font-bold text-sm" id="stress-val">3</span>
                        </div>
                        <input class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" id="stress"
                            name="stress" type="range" min="1" max="5" value="3"
                            oninput="document.getElementById('stress-val').innerText = this.value">
                        <div class="flex justify-between text-[10px] text-gray-400 mt-1 font-medium">
                            <span>üòå Low</span>
                            <span>üò¨ High</span>
                        </div>
                    </div>
                </div>

                <!-- Exercise Toggle -->
                <div class="flex items-center justify-between bg-gray-50 p-4 rounded-lg border border-gray-100 cursor-pointer"
                    onclick="document.getElementById('exercise').click()">
                    <span class="text-sm font-semibold text-gray-700">Did you exercise today?</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="exercise" name="exercise" class="sr-only peer">
                        <div
                            class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                        </div>
                    </label>
                </div>

                <button
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg shadow-indigo-200 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition duration-300 transform hover:-translate-y-1"
                    type="submit">
                    Analyze My Status
                </button>
            </form>

            <!-- Personal History List -->
            <div class="mt-8 pt-6 border-t border-gray-100">
                <h3 class="text-sm font-bold text-gray-900 mb-3 flex items-center justify-between">
                    <span>My Personal History</span>
                    <button onclick="clearHistory()"
                        class="text-xs text-red-400 hover:text-red-600 font-normal">Clear</button>
                </h3>
                <div id="personalHistory" class="space-y-2 max-h-48 overflow-y-auto scrollbar-hide text-xs">
                    <!-- History items injected here -->
                    <p class="text-gray-400 italic">No personal checks yet.</p>
                </div>
            </div>

            <!-- Mood Heatmap (New Feature) -->
            <div class="mt-8 pt-6 border-t border-gray-100">
                <h3 class="text-sm font-bold text-gray-900 mb-3">Mood Heatmap (Last 7 Days)</h3>
                <div class="heatmap-grid" id="moodHeatmap">
                    <!-- Cells injected via JS -->
                </div>
                <div class="flex justify-between text-[10px] text-gray-400 mt-2">
                    <span>Older</span>
                    <span>Today</span>
                </div>
            </div>

        </div>

        <!-- Right Column: Results & History (8 columns wide) -->
        <div class="col-span-1 lg:col-span-8 flex flex-col gap-6">

            <!-- Weekly Risk Alert -->
            <div id="riskAlert"
                class="hidden animate-pulse bg-red-50 border-l-4 border-red-500 p-4 rounded-r shadow-sm flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-500" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                            clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700 font-bold">‚ö†Ô∏è Weekly Risk Alert</p>
                    <p class="text-xs text-red-600 mt-1">Your burnout risk has been consistently high (>70) this week.
                        Please prioritize recovery.</p>
                </div>
            </div>

            <!-- What If Simulator (New Feature) -->
            <div id="simulator" class="bg-indigo-900 text-white p-6 rounded-2xl shadow-lg hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg flex items-center">
                        <span class="mr-2">üîÆ</span> "What If" Simulator
                    </h3>
                    <button onclick="closeSimulator()" class="text-indigo-300 hover:text-white">&times;</button>
                </div>
                <p class="text-indigo-200 text-sm mb-4">See how changing your habits affects your burnout score
                    immediately.</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-bold uppercase tracking-wide text-indigo-300 mb-2">Sleep
                            (Hours)</label>
                        <input type="range" min="0" max="12" step="0.5" id="sim-sleep" class="w-full accent-white"
                            oninput="updateSim()">
                        <div class="text-right text-sm font-bold" id="sim-sleep-val">6h</div>
                    </div>
                    <div>
                        <label
                            class="block text-xs font-bold uppercase tracking-wide text-indigo-300 mb-2">Deadlines</label>
                        <input type="range" min="0" max="10" step="1" id="sim-deadlines" class="w-full accent-white"
                            oninput="updateSim()">
                        <div class="text-right text-sm font-bold" id="sim-deadlines-val">3</div>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-indigo-800 flex justify-between items-center">
                    <div class="text-sm">
                        Predicted Score:
                        <span class="text-3xl font-bold ml-2" id="sim-score">--</span>
                    </div>
                    <div id="sim-message" class="text-xs font-medium bg-indigo-800 px-3 py-1 rounded text-indigo-200">
                        Adjust sliders to simulate
                    </div>
                </div>
            </div>

            <!-- Result Placeholder -->
            <div id="result">
                <!-- Empty State -->
                <div
                    class="bg-white p-12 rounded-2xl shadow-sm border border-gray-100 text-center h-full flex flex-col justify-center items-center text-gray-400">
                    <svg class="w-16 h-16 mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    <p class="text-lg font-medium">Fill out the form to generate your report.</p>
                </div>
            </div>

            <!-- Global Trend History -->
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-gray-100 flex-grow">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-gray-800">Community Trend</h2>
                    <span class="text-xs font-medium text-gray-400 bg-gray-50 px-2 py-1 rounded">Last 10 Global
                        Entries</span>
                </div>
                <div class="relative h-48 md:h-64 w-full">
                    <canvas id="burnoutChart"></canvas>
                </div>
            </div>

        </div>

    </div>

    <script>
        // --- CHART JS ---
        const ctx = document.getElementById('burnoutChart').getContext('2d');
        let gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(79, 70, 229, 0.4)');
        gradient.addColorStop(1, 'rgba(79, 70, 229, 0.0)');

        let burnoutChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Burnout Score',
                    data: [],
                    borderColor: '#4F46E5',
                    backgroundColor: gradient,
                    borderWidth: 3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#4F46E5',
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 100, grid: { color: '#F3F4F6', borderDash: [5, 5] }, ticks: { font: { size: 10, family: 'Inter' }, color: '#9CA3AF' }, border: { display: false } },
                    x: { grid: { display: false }, ticks: { font: { size: 10, family: 'Inter' }, color: '#9CA3AF' }, border: { display: false } }
                },
                plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1F2937', padding: 12, titleFont: { family: 'Inter', size: 12 }, bodyFont: { family: 'Inter', size: 12 }, displayColors: false, cornerRadius: 8, callbacks: { label: function (context) { return 'Score: ' + context.parsed.y; } } } }
            }
        });

        async function updateChart() {
            try {
                const response = await fetch('/history-chart');
                const data = await response.json();
                if (!data.labels) return;
                burnoutChart.data.labels = data.labels;
                burnoutChart.data.datasets[0].data = data.data;
                burnoutChart.update();
            } catch (error) { console.error('Error fetching chart data:', error); }
        }
        updateChart();

        // --- LOCAL STORAGE & HISTORY ---
        const STORAGE_KEY = 'burnout_history';

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const container = document.getElementById('personalHistory');

            // Render List
            if (history.length === 0) {
                container.innerHTML = '<p class="text-gray-400 italic">No personal checks yet.</p>';
            } else {
                // Check Weekly Risk (Last 3 scores > 70)
                const recentHighRisk = history.slice(0, 3).filter(h => h.score > 70);
                const alertBox = document.getElementById('riskAlert');
                if (recentHighRisk.length >= 3) {
                    alertBox.classList.remove('hidden');
                } else {
                    alertBox.classList.add('hidden');
                }

                container.innerHTML = history.map(h => {
                    let color = 'text-green-600';
                    if (h.score > 30) color = 'text-yellow-600';
                    if (h.score > 60) color = 'text-orange-600';
                    if (h.score > 80) color = 'text-red-600';

                    return `
                    <div class="flex justify-between items-center bg-gray-50 p-2 rounded border border-gray-100">
                        <span class="text-gray-500">${h.date}</span>
                        <span class="font-bold ${color}">${Math.round(h.score)}</span>
                    </div>`;
                }).join('');
            }

            renderHeatmap(history);
        }

        function renderHeatmap(history) {
            const heatmapContainer = document.getElementById('moodHeatmap');
            heatmapContainer.innerHTML = '';

            // Create 7 cells (last 7 entries or days)
            // For simplicity, we just take the last 7 entries, regardless of actual date gaps.
            // Fill with empty if less than 7.

            const maxCells = 7;
            const data = history.slice(0, maxCells).reverse(); // Oldest to newest

            // Pad start with empty
            const paddedData = Array(maxCells - data.length).fill(null).concat(data);

            paddedData.forEach(entry => {
                const cell = document.createElement('div');
                cell.className = 'heatmap-cell bg-gray-200'; // Default gray

                if (entry) {
                    if (entry.score <= 30) cell.className = 'heatmap-cell bg-green-400';
                    else if (entry.score <= 60) cell.className = 'heatmap-cell bg-yellow-400';
                    else if (entry.score <= 80) cell.className = 'heatmap-cell bg-orange-400';
                    else cell.className = 'heatmap-cell bg-red-500';

                    cell.title = `${entry.date}: ${Math.round(entry.score)}`;
                }

                heatmapContainer.appendChild(cell);
            });
        }

        function saveToHistory(score) {
            const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const newEntry = {
                score: parseFloat(score),
                date: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })
            };
            history.unshift(newEntry); // Add to top
            // Keep only last 20
            if (history.length > 20) history.pop();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
            loadHistory();

            // Show Simulator after a calculation is done
            showSimulator(score);
        }

        function clearHistory() {
            if (confirm('Clear your personal history?')) {
                localStorage.removeItem(STORAGE_KEY);
                loadHistory();
            }
        }

        // --- SIMULATOR ---
        function showSimulator(currentScore) {
            // Get current values from form
            const sleep = parseFloat(document.getElementById('sleep').value) || 6;
            const deadlines = parseFloat(document.getElementById('deadlines').value) || 3;

            document.getElementById('sim-sleep').value = sleep;
            document.getElementById('sim-deadlines').value = deadlines;

            document.getElementById('simulator').classList.remove('hidden');
            updateSim();
        }

        function closeSimulator() {
            document.getElementById('simulator').classList.add('hidden');
        }

        function updateSim() {
            const sleep = parseFloat(document.getElementById('sim-sleep').value);
            const deadlines = parseFloat(document.getElementById('sim-deadlines').value);

            document.getElementById('sim-sleep-val').innerText = sleep + 'h';
            document.getElementById('sim-deadlines-val').innerText = deadlines;

            // Re-implement logic in JS for simulation
            // Logic: (deadline * 10) + (stress * 12) + ((8 - sleep) * 8) + (study * 3) - (exercise ? 10 : 0)
            // We need other values too, assume current form values
            const stress = parseInt(document.getElementById('stress').value) || 3;
            const study = parseFloat(document.getElementById('study').value) || 4;
            const exercise = document.getElementById('exercise').checked;

            const sleepPenalty = (8.0 - sleep) * 8.0;
            const exerciseBonus = exercise ? 10.0 : 0.0;

            let rawScore = (deadlines * 10.0) + (stress * 12.0) + sleepPenalty + (study * 3.0) - exerciseBonus;
            let score = Math.max(0, Math.min(100, rawScore));

            const scoreEl = document.getElementById('sim-score');
            scoreEl.innerText = Math.round(score);

            // Color update
            if (score <= 30) scoreEl.className = "text-3xl font-bold ml-2 text-green-300";
            else if (score <= 60) scoreEl.className = "text-3xl font-bold ml-2 text-yellow-300";
            else if (score <= 80) scoreEl.className = "text-3xl font-bold ml-2 text-orange-300";
            else scoreEl.className = "text-3xl font-bold ml-2 text-red-400";

            // Dynamic message
            const msgEl = document.getElementById('sim-message');
            const originalScore = parseFloat(document.querySelector('#result h2 + div span')?.innerText || score); // Try to get original if possible

            // Note: Since we don't store original score easily here without passing it, we just show generic status
            if (sleep >= 8 && score < 50) {
                msgEl.innerText = "Great! More sleep is helping significantly.";
                msgEl.className = "text-xs font-medium bg-green-800 px-3 py-1 rounded text-green-100";
            } else if (deadlines > 5) {
                msgEl.innerText = "High deadlines are spiking your risk.";
                msgEl.className = "text-xs font-medium bg-red-800 px-3 py-1 rounded text-red-100";
            } else {
                msgEl.innerText = "Adjust sliders to simulate scenarios";
                msgEl.className = "text-xs font-medium bg-indigo-800 px-3 py-1 rounded text-indigo-200";
            }
        }

        // --- PDF GENERATION ---
        window.generatePDF = function (score, level, advice, date) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFont("helvetica", "bold"); doc.setFontSize(22); doc.setTextColor(79, 70, 229);
            doc.text("Burnout Detector Report", 20, 20);
            doc.setFont("helvetica", "normal"); doc.setFontSize(10); doc.setTextColor(100);
            doc.text("Generated on: " + date, 20, 30);
            doc.setLineWidth(0.5); doc.line(20, 35, 190, 35);
            doc.setFontSize(16); doc.setTextColor(0);
            doc.text("Burnout Score: " + Math.round(score) + " / 100", 20, 50);
            doc.setFontSize(14); doc.text("Risk Level: " + level, 20, 60);
            doc.setFontSize(12); doc.setFont("helvetica", "bold"); doc.text("AI Personal Insight:", 20, 80);
            doc.setFont("helvetica", "normal"); doc.setFontSize(11);
            const splitAdvice = doc.splitTextToSize(advice, 170);
            doc.text(splitAdvice, 20, 90);
            doc.save("burnout-report.pdf");
        }

        // --- EVENT LISTENERS ---
        loadHistory(); // Load on start

        document.body.addEventListener('newEntry', function (evt) {
            updateChart();
            // Note: The saving to localStorage happens via inline script in the response from Go
        });
    </script>
</body>

</html>